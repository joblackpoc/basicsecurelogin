{% extends 'base.html' %}

{% block title %}User Details - {{ target_user.first_name }} {{ target_user.last_name }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>
                <i class="fas fa-user me-2"></i>{{ target_user.first_name }} {{ target_user.last_name }}
            </h2>
            <a href="{% url 'authentication:admin_user_management' %}" class="btn btn-outline-primary">
                <i class="fas fa-arrow-left me-2"></i>Back to User Management
            </a>
        </div>
    </div>
</div>

<!-- Migration Warning -->
{% if migration_needed %}
<div class="row mb-4">
    <div class="col-12">
        <div class="alert alert-info">
            <h5><i class="fas fa-info-circle me-2"></i>Limited Admin Features</h5>
            <p class="mb-0">Some admin actions are limited until database migration is complete. Run: <code>python manage.py migrate</code></p>
        </div>
    </div>
</div>
{% endif %}

<div class="row">
    <!-- User Information -->
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-user-circle me-2"></i>User Information
                </h5>
            </div>
            <div class="card-body">
                <div class="row mb-2">
                    <div class="col-sm-4"><strong>Name:</strong></div>
                    <div class="col-sm-8">{{ target_user.first_name }} {{ target_user.last_name }}</div>
                </div>
                <div class="row mb-2">
                    <div class="col-sm-4"><strong>Username:</strong></div>
                    <div class="col-sm-8">{{ target_user.username }}</div>
                </div>
                <div class="row mb-2">
                    <div class="col-sm-4"><strong>Email:</strong></div>
                    <div class="col-sm-8">{{ target_user.email }}</div>
                </div>
                <div class="row mb-2">
                    <div class="col-sm-4"><strong>Phone:</strong></div>
                    <div class="col-sm-8">{{ target_user.phone_number|default:"Not provided" }}</div>
                </div>
                <div class="row mb-2">
                    <div class="col-sm-4"><strong>Joined:</strong></div>
                    <div class="col-sm-8">{{ target_user.created_at|date:"F d, Y H:i" }}</div>
                </div>
                <div class="row mb-2">
                    <div class="col-sm-4"><strong>Last Login:</strong></div>
                    <div class="col-sm-8">
                        {% if target_user.last_login %}
                            {{ target_user.last_login|date:"F d, Y H:i" }}
                        {% else %}
                            <span class="text-muted">Never</span>
                        {% endif %}
                    </div>
                </div>
                <div class="row mb-2">
                    <div class="col-sm-4"><strong>Last IP:</strong></div>
                    <div class="col-sm-8">
                        {% if target_user.last_login_ip %}
                            <code>{{ target_user.last_login_ip }}</code>
                        {% else %}
                            <span class="text-muted">Unknown</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Account Status -->
        <div class="card mt-3">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>Account Status
                </h5>
            </div>
            <div class="card-body">
                <div class="row mb-2">
                    <div class="col-sm-5"><strong>Approval:</strong></div>
                    <div class="col-sm-7">
                        {% if target_user.is_banned|default:False %}
                            <span class="badge bg-danger">Banned</span>
                        {% elif target_user.approval_status == 'pending' %}
                            <span class="badge bg-warning">Pending</span>
                        {% elif target_user.approval_status == 'approved' %}
                            <span class="badge bg-success">Approved</span>
                        {% elif target_user.approval_status == 'rejected' %}
                            <span class="badge bg-secondary">Rejected</span>
                        {% endif %}
                    </div>
                </div>
                
                <div class="row mb-2">
                    <div class="col-sm-5"><strong>Active:</strong></div>
                    <div class="col-sm-7">
                        {% if target_user.is_active %}
                            <span class="badge bg-success">Yes</span>
                        {% else %}
                            <span class="badge bg-danger">No</span>
                        {% endif %}
                    </div>
                </div>
                
                <div class="row mb-2">
                    <div class="col-sm-5"><strong>Locked:</strong></div>
                    <div class="col-sm-7">
                        {% if target_user.is_locked %}
                            <span class="badge bg-warning">Yes</span>
                            <br><small>Until: {{ target_user.locked_until|date:"M d, Y H:i" }}</small>
                        {% else %}
                            <span class="badge bg-success">No</span>
                        {% endif %}
                    </div>
                </div>
                
                <div class="row mb-2">
                    <div class="col-sm-5"><strong>Failed Logins:</strong></div>
                    <div class="col-sm-7">
                        <span class="badge bg-{% if target_user.login_attempts > 3 %}danger{% elif target_user.login_attempts > 0 %}warning{% else %}success{% endif %}">
                            {{ target_user.login_attempts }}
                        </span>
                    </div>
                </div>
                
                {% if target_user.approved_by %}
                    <div class="row mb-2">
                        <div class="col-sm-5"><strong>Approved By:</strong></div>
                        <div class="col-sm-7">{{ target_user.approved_by.first_name }} {{ target_user.approved_by.last_name }}</div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-sm-5"><strong>Approved At:</strong></div>
                        <div class="col-sm-7">{{ target_user.approved_at|date:"M d, Y H:i" }}</div>
                    </div>
                {% endif %}
                
                {% if target_user.is_banned|default:False %}
                    {% if target_user.banned_by|default:None %}
                        <div class="row mb-2">
                            <div class="col-sm-5"><strong>Banned By:</strong></div>
                            <div class="col-sm-7">{{ target_user.banned_by.first_name }} {{ target_user.banned_by.last_name }}</div>
                        </div>
                    {% endif %}
                    {% if target_user.banned_at|default:None %}
                        <div class="row mb-2">
                            <div class="col-sm-5"><strong>Banned At:</strong></div>
                            <div class="col-sm-7">{{ target_user.banned_at|date:"M d, Y H:i" }}</div>
                        </div>
                    {% endif %}
                    {% if target_user.ban_reason|default:"" %}
                        <div class="row mb-2">
                            <div class="col-12"><strong>Ban Reason:</strong></div>
                            <div class="col-12">
                                <div class="alert alert-warning">{{ target_user.ban_reason }}</div>
                            </div>
                        </div>
                    {% endif %}
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Security & Actions -->
    <div class="col-lg-8">
        <!-- Security Status -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-shield-alt me-2"></i>Security Status
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Multi-Factor Authentication</h6>
                        <div class="d-flex align-items-center mb-2">
                            <span class="me-2">Status:</span>
                            {% if target_user.mfa_enabled %}
                                <span class="badge bg-success">Enabled</span>
                            {% else %}
                                <span class="badge bg-warning">Disabled</span>
                            {% endif %}
                            
                            {% if target_user.mfa_required|default:False %}
                                <span class="badge bg-info ms-1">Required</span>
                            {% endif %}
                        </div>
                        
                        {% if totp_devices %}
                            <small class="text-muted">
                                TOTP Devices: {{ totp_devices.count }}
                                {% with confirmed_count=totp_devices|length %}
                                    ({{ confirmed_count }} confirmed)
                                {% endwith %}
                            </small>
                        {% endif %}
                    </div>
                    
                    <div class="col-md-6">
                        <h6>Login Security</h6>
                        <p><small>Failed attempts: <strong>{{ target_user.login_attempts }}</strong></small></p>
                        {% if target_user.is_locked %}
                            <p><small class="text-danger">Account locked until {{ target_user.locked_until|date:"M d, Y H:i" }}</small></p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Admin Actions -->
        <div class="card mt-3">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-cogs me-2"></i>Admin Actions
                </h5>
            </div>
            <div class="card-body">
                <div class="row g-2">
                    <!-- Approval Actions -->
                    {% if target_user.approval_status == 'pending' %}
                        <div class="col-md-6">
                            <form method="post" action="{% url 'authentication:admin_approve_user' target_user.id %}">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-success w-100" onclick="return confirm('Approve this user?')">
                                    <i class="fas fa-check me-2"></i>Approve User
                                </button>
                            </form>
                        </div>
                        <div class="col-md-6">
                            <button type="button" class="btn btn-warning w-100" onclick="rejectUser()">
                                <i class="fas fa-times me-2"></i>Reject User
                            </button>
                        </div>
                    {% endif %}
                    
                    <!-- Ban/Unban Actions (only if migration complete) -->
                    {% if not migration_needed %}
                        {% if not target_user.is_banned|default:False and target_user.approval_status == 'approved' %}
                            <div class="col-md-6">
                                <button type="button" class="btn btn-danger w-100" onclick="banUser()">
                                    <i class="fas fa-ban me-2"></i>Ban User
                                </button>
                            </div>
                        {% elif target_user.is_banned|default:False %}
                            <div class="col-md-6">
                                <form method="post" action="{% url 'authentication:admin_unban_user' target_user.id %}">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-success w-100" onclick="return confirm('Unban this user?')">
                                        <i class="fas fa-undo me-2"></i>Unban User
                                    </button>
                                </form>
                            </div>
                        {% endif %}
                        
                        <!-- MFA Actions -->
                        {% if not target_user.mfa_required|default:False %}
                            <div class="col-md-6">
                                <form method="post" action="{% url 'authentication:admin_force_mfa' target_user.id %}">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-info w-100" onclick="return confirm('Force MFA setup for this user?')">
                                        <i class="fas fa-mobile-alt me-2"></i>Force MFA Setup
                                    </button>
                                </form>
                            </div>
                        {% endif %}
                    {% endif %}
                    
                    {% if target_user.mfa_enabled %}
                        <div class="col-md-6">
                            <form method="post" action="{% url 'authentication:admin_disable_mfa' target_user.id %}">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-outline-danger w-100" onclick="return confirm('Disable MFA for this user?')">
                                    <i class="fas fa-times me-2"></i>Disable MFA
                                </button>
                            </form>
                        </div>
                    {% endif %}
                    
                    <!-- Account Unlock -->
                    {% if target_user.is_locked %}
                        <div class="col-md-6">
                            <form method="post" action="{% url 'authentication:admin_unlock_account' target_user.id %}">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-warning w-100" onclick="return confirm('Unlock this account?')">
                                    <i class="fas fa-unlock me-2"></i>Unlock Account
                                </button>
                            </form>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Recent Login Attempts -->
        <div class="card mt-3">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-sign-in-alt me-2"></i>Recent Login Attempts
                </h5>
            </div>
            <div class="card-body">
                {% if login_attempts %}
                    <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Date/Time</th>
                                    <th>Status</th>
                                    <th>IP Address</th>
                                    <th>User Agent</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for attempt in login_attempts %}
                                    <tr>
                                        <td><small>{{ attempt.timestamp|date:"M d, Y H:i:s" }}</small></td>
                                        <td>
                                            {% if attempt.success %}
                                                <span class="badge bg-success">Success</span>
                                            {% else %}
                                                <span class="badge bg-danger">Failed</span>
                                            {% endif %}
                                        </td>
                                        <td><code>{{ attempt.ip_address }}</code></td>
                                        <td><small>{{ attempt.user_agent|truncatechars:40 }}</small></td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-muted">No login attempts recorded.</p>
                {% endif %}
            </div>
        </div>
        
        <!-- Activity Log -->
        <div class="card mt-3">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-history me-2"></i>Admin Activity Log
                </h5>
            </div>
            <div class="card-body">
                {% if activity_logs %}
                    <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Date/Time</th>
                                    <th>Admin</th>
                                    <th>Action</th>
                                    <th>Reason</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for log in activity_logs %}
                                    <tr>
                                        <td><small>{{ log.timestamp|date:"M d, Y H:i" }}</small></td>
                                        <td>{{ log.admin_user.first_name }} {{ log.admin_user.last_name }}</td>
                                        <td>
                                            <span class="badge bg-{% if log.action == 'approved' %}success{% elif log.action == 'banned' %}danger{% elif log.action == 'rejected' %}warning{% else %}info{% endif %}">
                                                {{ log.get_action_display }}
                                            </span>
                                        </td>
                                        <td><small>{{ log.reason|default:"—" }}</small></td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% elif migration_needed %}
                    <div class="text-center py-4">
                        <i class="fas fa-database fa-3x text-muted mb-3"></i>
                        <p class="text-muted">Activity logging will be available after migration.</p>
                    </div>
                {% else %}
                    <p class="text-muted">No admin actions recorded.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Ban User Modal -->
{% if not migration_needed %}
<div class="modal fade" id="banUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ban User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="{% url 'authentication:admin_ban_user' target_user.id %}">
                {% csrf_token %}
                <div class="modal-body">
                    <p>Are you sure you want to ban <strong>{{ target_user.first_name }} {{ target_user.last_name }}</strong>?</p>
                    <div class="mb-3">
                        <label for="banReason" class="form-label">Reason for ban (optional):</label>
                        <textarea name="reason" id="banReason" class="form-control" rows="3" placeholder="Enter reason for banning this user..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Ban User</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

<!-- Reject User Modal -->
<div class="modal fade" id="rejectUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Reject User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="{% url 'authentication:admin_reject_user' target_user.id %}">
                {% csrf_token %}
                <div class="modal-body">
                    <p>Are you sure you want to reject <strong>{{ target_user.first_name }} {{ target_user.last_name }}</strong>?</p>
                    <div class="mb-3">
                        <label for="rejectReason" class="form-label">Reason for rejection (optional):</label>
                        <textarea name="reason" id="rejectReason" class="form-control" rows="3" placeholder="Enter reason for rejecting this user..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning">Reject User</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function banUser() {
    new bootstrap.Modal(document.getElementById('banUserModal')).show();
}

function rejectUser() {
    new bootstrap.Modal(document.getElementById('rejectUserModal')).show();
}
</script>
{% endblock %}